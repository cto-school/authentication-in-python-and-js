<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Part 12: Change Password</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

    <div class="container py-5">
        <h1 class="text-center mb-4">Part 12: Change Password</h1>
        <p class="text-center text-muted mb-5">Allow logged-in users to change their password</p>

        <!-- ================================== -->
        <!-- User Status -->
        <!-- ================================== -->
        <div class="row justify-content-center mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-dark text-white d-flex justify-content-between">
                        <h5 class="mb-0">Current User</h5>
                        <button onclick="logout()" class="btn btn-sm btn-outline-light">Logout</button>
                    </div>
                    <div class="card-body">
                        <div id="userStatus">
                            <p class="text-muted mb-0">Not logged in</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row justify-content-center">
            <!-- ================================== -->
            <!-- Login Section -->
            <!-- ================================== -->
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">1. Login First</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="email" id="email" class="form-control" placeholder="Email">
                        </div>
                        <div class="mb-3">
                            <input type="password" id="password" class="form-control" placeholder="Password">
                        </div>
                        <button onclick="register()" class="btn btn-outline-primary w-100 mb-2">Register</button>
                        <button onclick="login()" class="btn btn-primary w-100">Login</button>
                        <div id="authResult" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- ================================== -->
            <!-- Change Password Section -->
            <!-- ================================== -->
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0">2. Change Password</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label small">Current Password:</label>
                            <input type="password" id="currentPassword" class="form-control" placeholder="Current password">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">New Password:</label>
                            <input type="password" id="newPassword" class="form-control" placeholder="New password (min 6 chars)">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">Confirm New Password:</label>
                            <input type="password" id="confirmPassword" class="form-control" placeholder="Confirm new password">
                        </div>
                        <button onclick="changePassword()" class="btn btn-warning w-100">
                            Change Password
                        </button>
                        <div id="changeResult" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- ================================== -->
            <!-- Test Section -->
            <!-- ================================== -->
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">3. Test New Password</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small">After changing password, test login with new credentials:</p>
                        <div class="mb-3">
                            <input type="email" id="testEmail" class="form-control" placeholder="Email">
                        </div>
                        <div class="mb-3">
                            <input type="password" id="testPassword" class="form-control" placeholder="New password">
                        </div>
                        <button onclick="testLogin()" class="btn btn-success w-100">
                            Test Login
                        </button>
                        <div id="testResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================================== -->
        <!-- Info Card -->
        <!-- ================================== -->
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Change vs Reset Password</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-bordered mb-0">
                            <thead>
                                <tr>
                                    <th>Feature</th>
                                    <th>Reset Password</th>
                                    <th>Change Password</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>When to use</td>
                                    <td>Forgot password</td>
                                    <td>Know current password</td>
                                </tr>
                                <tr>
                                    <td>Authentication</td>
                                    <td>Token from email</td>
                                    <td>Must be logged in</td>
                                </tr>
                                <tr>
                                    <td>Verification</td>
                                    <td>Email link token</td>
                                    <td>Current password</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================================== -->
        <!-- Congratulations -->
        <!-- ================================== -->
        <div class="row justify-content-center mt-4">
            <div class="col-md-8">
                <div class="alert alert-success text-center">
                    <h4>Congratulations!</h4>
                    <p class="mb-0">You have completed the Authentication Module!</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5012';

        // ===========================================
        // Auth Functions
        // ===========================================

        async function register() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showResult('authResult', 'Enter email and password', 'warning');
                return;
            }

            try {
                const response = await fetch(API_URL + '/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();

                showResult('authResult', data.message, response.ok ? 'success' : 'danger');

                if (response.ok) {
                    document.getElementById('testEmail').value = email;
                }
            } catch (error) {
                showResult('authResult', 'Network error', 'danger');
            }
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showResult('authResult', 'Enter email and password', 'warning');
                return;
            }

            try {
                const response = await fetch(API_URL + '/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();

                if (response.ok) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));

                    showResult('authResult', 'Login successful!', 'success');
                    updateUserStatus(data.user);

                    // Copy email to test field
                    document.getElementById('testEmail').value = email;
                } else {
                    showResult('authResult', data.message, 'danger');
                }
            } catch (error) {
                showResult('authResult', 'Network error', 'danger');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            updateUserStatus(null);
            showResult('authResult', 'Logged out', 'info');
        }

        // ===========================================
        // Change Password
        // ===========================================

        async function changePassword() {
            const token = localStorage.getItem('token');

            if (!token) {
                showResult('changeResult', 'Please login first', 'warning');
                return;
            }

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validate
            if (!currentPassword) {
                showResult('changeResult', 'Enter current password', 'warning');
                return;
            }

            if (!newPassword) {
                showResult('changeResult', 'Enter new password', 'warning');
                return;
            }

            if (newPassword.length < 6) {
                showResult('changeResult', 'New password must be at least 6 characters', 'warning');
                return;
            }

            if (newPassword !== confirmPassword) {
                showResult('changeResult', 'New passwords do not match!', 'warning');
                return;
            }

            try {
                const response = await fetch(API_URL + '/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });
                const data = await response.json();

                if (response.ok) {
                    showResult('changeResult',
                        `${data.message}<br><small>Changed at: ${data.password_changed_at}</small>`,
                        'success'
                    );

                    // Clear form
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';

                    // Copy new password to test field
                    document.getElementById('testPassword').value = newPassword;
                } else {
                    showResult('changeResult', data.message, 'danger');
                }
            } catch (error) {
                showResult('changeResult', 'Network error', 'danger');
            }
        }

        // ===========================================
        // Test Login
        // ===========================================

        async function testLogin() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;

            if (!email || !password) {
                showResult('testResult', 'Enter email and password', 'warning');
                return;
            }

            try {
                const response = await fetch(API_URL + '/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();

                if (response.ok) {
                    showResult('testResult', 'Login successful! New password works.', 'success');
                } else {
                    showResult('testResult', data.message, 'danger');
                }
            } catch (error) {
                showResult('testResult', 'Network error', 'danger');
            }
        }

        // ===========================================
        // Helpers
        // ===========================================

        function showResult(elementId, message, type) {
            document.getElementById(elementId).innerHTML = `
                <div class="alert alert-${type} py-2 mb-0 small">${message}</div>
            `;
        }

        function updateUserStatus(user) {
            const statusDiv = document.getElementById('userStatus');

            if (user) {
                statusDiv.innerHTML = `
                    <p class="mb-0">
                        <strong>Email:</strong> ${user.email}<br>
                        <small class="text-muted">
                            Registered: ${user.created_at}
                            ${user.password_changed_at ? '<br>Password changed: ' + user.password_changed_at : ''}
                        </small>
                    </p>
                `;
            } else {
                statusDiv.innerHTML = `<p class="text-muted mb-0">Not logged in</p>`;
            }
        }

        // Check if user is already logged in
        window.onload = function() {
            const userStr = localStorage.getItem('user');
            if (userStr) {
                const user = JSON.parse(userStr);
                updateUserStatus(user);
            }
        };
    </script>

</body>
</html>
