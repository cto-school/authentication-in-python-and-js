<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Part 3: User Login</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

    <div class="container py-5">
        <!-- Page Title -->
        <h1 class="text-center mb-4">Part 3: User Login</h1>
        <p class="text-center text-muted mb-5">Register and Login to get JWT token</p>

        <div class="row">
            <!-- ================================== -->
            <!-- Register Form -->
            <!-- ================================== -->
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">1. Register</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Email:</label>
                            <input type="email" id="registerEmail" class="form-control" placeholder="Enter email">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password:</label>
                            <input type="password" id="registerPassword" class="form-control" placeholder="Enter password">
                        </div>
                        <button onclick="register()" class="btn btn-primary w-100">
                            Register
                        </button>
                        <div id="registerResult" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- ================================== -->
            <!-- Login Form -->
            <!-- ================================== -->
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">2. Login</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Email:</label>
                            <input type="email" id="loginEmail" class="form-control" placeholder="Enter email">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password:</label>
                            <input type="password" id="loginPassword" class="form-control" placeholder="Enter password">
                        </div>
                        <button onclick="login()" class="btn btn-success w-100">
                            Login
                        </button>
                        <div id="loginResult" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- ================================== -->
            <!-- Token Display -->
            <!-- ================================== -->
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0">3. Stored Token</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small">Token stored in localStorage:</p>

                        <!-- Token Display Area -->
                        <div id="tokenDisplay" class="bg-light p-2 rounded mb-3" style="word-break: break-all; max-height: 150px; overflow-y: auto;">
                            <small class="text-muted">No token stored</small>
                        </div>

                        <!-- Clear Token Button -->
                        <button onclick="clearToken()" class="btn btn-outline-danger w-100">
                            Clear Token (Logout)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================================== -->
        <!-- User Info (Shown after login) -->
        <!-- ================================== -->
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Logged In User Info</h5>
                    </div>
                    <div class="card-body">
                        <div id="userInfo">
                            <p class="text-muted">Login to see your info here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================================== -->
    <!-- JavaScript Code -->
    <!-- ================================== -->
    <script>
        // Backend API URL
        const API_URL = 'http://localhost:5003';

        // -----------------------------------------
        // Function: Register User
        // -----------------------------------------
        async function register() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            // Validate
            if (!email || !password) {
                showResult('registerResult', 'Please enter email and password', 'danger');
                return;
            }

            try {
                // Call register API
                const response = await fetch(API_URL + '/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    showResult('registerResult', data.message, 'success');
                    // Clear form
                    document.getElementById('registerEmail').value = '';
                    document.getElementById('registerPassword').value = '';
                } else {
                    showResult('registerResult', data.message, 'danger');
                }

            } catch (error) {
                showResult('registerResult', 'Error: ' + error.message, 'danger');
            }
        }

        // -----------------------------------------
        // Function: Login User
        // -----------------------------------------
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            // Validate
            if (!email || !password) {
                showResult('loginResult', 'Please enter email and password', 'danger');
                return;
            }

            try {
                // Call login API
                const response = await fetch(API_URL + '/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    // SUCCESS! We got a token

                    // Step 1: Save token to localStorage
                    // localStorage.setItem(key, value) saves data in browser
                    // This data persists even after closing the browser
                    localStorage.setItem('token', data.token);

                    // Step 2: Also save user info
                    localStorage.setItem('user', JSON.stringify(data.user));

                    // Step 3: Show success message
                    showResult('loginResult', 'Login successful!', 'success');

                    // Step 4: Update the display
                    displayToken();
                    displayUserInfo(data.user);

                    // Clear form
                    document.getElementById('loginEmail').value = '';
                    document.getElementById('loginPassword').value = '';

                } else {
                    showResult('loginResult', data.message, 'danger');
                }

            } catch (error) {
                showResult('loginResult', 'Error: ' + error.message, 'danger');
            }
        }

        // -----------------------------------------
        // Function: Clear Token (Logout)
        // -----------------------------------------
        function clearToken() {
            // Remove token from localStorage
            localStorage.removeItem('token');
            localStorage.removeItem('user');

            // Update display
            displayToken();
            displayUserInfo(null);

            showResult('loginResult', 'Logged out successfully', 'info');
        }

        // -----------------------------------------
        // Function: Display Token
        // -----------------------------------------
        function displayToken() {
            // Get token from localStorage
            const token = localStorage.getItem('token');

            const tokenDisplay = document.getElementById('tokenDisplay');

            if (token) {
                // Token exists - show it
                tokenDisplay.innerHTML = `<small class="text-success">${token}</small>`;
            } else {
                // No token
                tokenDisplay.innerHTML = `<small class="text-muted">No token stored</small>`;
            }
        }

        // -----------------------------------------
        // Function: Display User Info
        // -----------------------------------------
        function displayUserInfo(user) {
            const userInfo = document.getElementById('userInfo');

            if (user) {
                userInfo.innerHTML = `
                    <div class="alert alert-success">
                        <strong>Logged in as:</strong><br>
                        <ul class="mb-0">
                            <li>ID: ${user.id}</li>
                            <li>Email: ${user.email}</li>
                        </ul>
                    </div>
                `;
            } else {
                userInfo.innerHTML = `<p class="text-muted">Login to see your info here</p>`;
            }
        }

        // -----------------------------------------
        // Helper Function: Show Result Message
        // -----------------------------------------
        function showResult(elementId, message, type) {
            document.getElementById(elementId).innerHTML = `
                <div class="alert alert-${type} py-2">
                    ${message}
                </div>
            `;
        }

        // -----------------------------------------
        // On Page Load: Check for existing token
        // -----------------------------------------
        window.onload = function() {
            // Check if token already exists in localStorage
            displayToken();

            // Check if user info exists
            const userStr = localStorage.getItem('user');
            if (userStr) {
                const user = JSON.parse(userStr);
                displayUserInfo(user);
            }
        };
    </script>

</body>
</html>
