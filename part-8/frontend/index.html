<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Part 8: Error Handling</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Custom styles for error display */
        .field-error {
            border-color: #dc3545 !important;
        }
        .field-error-message {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body class="bg-light">

    <div class="container py-5">
        <h1 class="text-center mb-4">Part 8: Error Handling</h1>
        <p class="text-center text-muted mb-5">Proper error responses and display</p>

        <div class="row">
            <!-- ================================== -->
            <!-- Register with Validation -->
            <!-- ================================== -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Register (Test Validation Errors)</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small">Try submitting with invalid data to see error handling</p>

                        <!-- Email Field -->
                        <div class="mb-3">
                            <label class="form-label">Email:</label>
                            <input type="email" id="regEmail" class="form-control" placeholder="Enter email">
                            <div id="regEmailError" class="field-error-message"></div>
                        </div>

                        <!-- Password Field -->
                        <div class="mb-3">
                            <label class="form-label">Password:</label>
                            <input type="password" id="regPassword" class="form-control" placeholder="Min 6 characters">
                            <div id="regPasswordError" class="field-error-message"></div>
                        </div>

                        <button onclick="register()" class="btn btn-primary w-100">
                            Register
                        </button>

                        <!-- General Result -->
                        <div id="regResult" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- ================================== -->
            <!-- Login with Error Handling -->
            <!-- ================================== -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Login (Test Auth Errors)</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small">Try wrong password to see auth error</p>

                        <div class="mb-3">
                            <label class="form-label">Email:</label>
                            <input type="email" id="loginEmail" class="form-control" placeholder="Enter email">
                            <div id="loginEmailError" class="field-error-message"></div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Password:</label>
                            <input type="password" id="loginPassword" class="form-control" placeholder="Enter password">
                            <div id="loginPasswordError" class="field-error-message"></div>
                        </div>

                        <button onclick="login()" class="btn btn-success w-100">
                            Login
                        </button>

                        <div id="loginResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================================== -->
        <!-- Test Error Scenarios -->
        <!-- ================================== -->
        <div class="row">
            <div class="col-md-12 mb-4">
                <div class="card">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0">Test Error Scenarios</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">Click buttons to see different error responses:</p>

                        <div class="btn-group flex-wrap" role="group">
                            <button onclick="testError('validation')" class="btn btn-outline-danger m-1">
                                Validation Error
                            </button>
                            <button onclick="testError('auth')" class="btn btn-outline-danger m-1">
                                Auth Error
                            </button>
                            <button onclick="testError('not-found')" class="btn btn-outline-danger m-1">
                                Not Found Error
                            </button>
                            <button onclick="testError('server')" class="btn btn-outline-danger m-1">
                                Server Error
                            </button>
                            <button onclick="testError('exception')" class="btn btn-outline-danger m-1">
                                Unhandled Exception
                            </button>
                        </div>

                        <div id="testResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================================== -->
        <!-- Error Response Format -->
        <!-- ================================== -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Error Response Format</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Error Response:</h6>
                                <pre class="bg-dark text-white p-3 rounded">
{
    "success": false,
    "error": {
        "code": "VALIDATION_ERROR",
        "message": "Email is required",
        "field": "email"
    }
}</pre>
                            </div>
                            <div class="col-md-6">
                                <h6>Success Response:</h6>
                                <pre class="bg-dark text-white p-3 rounded">
{
    "success": true,
    "message": "Registration successful!",
    "data": {
        "id": 1,
        "email": "john@example.com"
    }
}</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5008';

        // ===========================================
        // Error Handling Utilities (NEW!)
        // ===========================================

        /**
         * Clear all field errors in a form
         */
        function clearFieldErrors(prefix) {
            // Remove error class from inputs
            document.querySelectorAll(`#${prefix}Email, #${prefix}Password`).forEach(el => {
                el.classList.remove('field-error');
            });

            // Clear error messages
            document.querySelectorAll(`#${prefix}EmailError, #${prefix}PasswordError`).forEach(el => {
                el.textContent = '';
            });
        }

        /**
         * Show field-specific error
         */
        function showFieldError(prefix, field, message) {
            const input = document.getElementById(`${prefix}${capitalize(field)}`);
            const errorDiv = document.getElementById(`${prefix}${capitalize(field)}Error`);

            if (input) {
                input.classList.add('field-error');
            }
            if (errorDiv) {
                errorDiv.textContent = message;
            }
        }

        /**
         * Capitalize first letter
         */
        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        /**
         * Handle API response with proper error handling
         */
        async function handleApiResponse(response) {
            const data = await response.json();

            return {
                ok: response.ok,
                status: response.status,
                data: data
            };
        }

        /**
         * Show result message
         */
        function showResult(elementId, message, type, details = null) {
            let html = `<div class="alert alert-${type} py-2">`;
            html += message;

            if (details) {
                html += `<br><small class="text-muted">Code: ${details.code}</small>`;
                if (details.field) {
                    html += `<br><small class="text-muted">Field: ${details.field}</small>`;
                }
            }

            html += '</div>';
            document.getElementById(elementId).innerHTML = html;
        }

        // ===========================================
        // Frontend Validation (NEW!)
        // ===========================================

        function validateEmail(email) {
            const pattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            return pattern.test(email);
        }

        function validateRegistration(prefix) {
            clearFieldErrors(prefix);

            const email = document.getElementById(`${prefix}Email`).value.trim();
            const password = document.getElementById(`${prefix}Password`).value;

            let isValid = true;

            // Validate email
            if (!email) {
                showFieldError(prefix, 'email', 'Email is required');
                isValid = false;
            } else if (!validateEmail(email)) {
                showFieldError(prefix, 'email', 'Invalid email format');
                isValid = false;
            }

            // Validate password
            if (!password) {
                showFieldError(prefix, 'password', 'Password is required');
                isValid = false;
            } else if (password.length < 6) {
                showFieldError(prefix, 'password', 'Password must be at least 6 characters');
                isValid = false;
            }

            return isValid;
        }

        // ===========================================
        // Register with Error Handling
        // ===========================================

        async function register() {
            const prefix = 'reg';

            // Frontend validation first
            if (!validateRegistration(prefix)) {
                showResult('regResult', 'Please fix the errors above', 'warning');
                return;
            }

            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;

            try {
                const response = await fetch(API_URL + '/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const result = await handleApiResponse(response);

                if (result.data.success) {
                    // Success
                    showResult('regResult', result.data.message, 'success');
                    clearFieldErrors(prefix);

                    // Copy email to login
                    document.getElementById('loginEmail').value = email;
                } else {
                    // Error from server
                    const error = result.data.error;

                    // Show field-specific error if available
                    if (error.field) {
                        showFieldError(prefix, error.field, error.message);
                    }

                    showResult('regResult', error.message, 'danger', error);
                }

            } catch (error) {
                // Network error
                showResult('regResult', 'Network error. Is the server running?', 'danger');
            }
        }

        // ===========================================
        // Login with Error Handling
        // ===========================================

        async function login() {
            const prefix = 'login';
            clearFieldErrors(prefix);

            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            // Basic validation
            if (!email) {
                showFieldError(prefix, 'email', 'Email is required');
                return;
            }
            if (!password) {
                showFieldError(prefix, 'password', 'Password is required');
                return;
            }

            try {
                const response = await fetch(API_URL + '/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const result = await handleApiResponse(response);

                if (result.data.success) {
                    showResult('loginResult', result.data.message, 'success');

                    // Save token
                    localStorage.setItem('token', result.data.data.token);
                } else {
                    const error = result.data.error;
                    showResult('loginResult', error.message, 'danger', error);
                }

            } catch (error) {
                showResult('loginResult', 'Network error. Is the server running?', 'danger');
            }
        }

        // ===========================================
        // Test Error Scenarios
        // ===========================================

        async function testError(errorType) {
            try {
                const response = await fetch(API_URL + '/test-error/' + errorType);
                const result = await handleApiResponse(response);

                // Display raw response
                const data = result.data;
                let html = `
                    <div class="alert ${data.success ? 'alert-success' : 'alert-danger'}">
                        <strong>Response (${result.status}):</strong>
                        <pre class="mt-2 mb-0">${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;

                document.getElementById('testResult').innerHTML = html;

            } catch (error) {
                document.getElementById('testResult').innerHTML = `
                    <div class="alert alert-danger">
                        Network error: ${error.message}
                    </div>
                `;
            }
        }
    </script>

</body>
</html>
