<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chapter 3: User Login & JWT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .token-display {
            word-break: break-all;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="text-center mb-5">
            <h1>Chapter 3: User Login & JWT</h1>
            <p class="text-muted">Authenticate users and receive JWT tokens</p>
            <span class="badge bg-primary">TIER 1: Foundation</span>
        </div>

        <div class="row">
            <!-- Register Form -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">1. Register First</h5>
                    </div>
                    <div class="card-body">
                        <form id="registerForm">
                            <div class="mb-3">
                                <input type="email" class="form-control" id="regEmail" placeholder="Email" required>
                            </div>
                            <div class="mb-3">
                                <input type="password" class="form-control" id="regPassword" placeholder="Password" required>
                            </div>
                            <button type="submit" class="btn btn-secondary w-100">Register</button>
                        </form>
                        <div id="registerResult" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- Login Form -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">2. Login</h5>
                    </div>
                    <div class="card-body">
                        <form id="loginForm">
                            <div class="mb-3">
                                <input type="email" class="form-control" id="loginEmail" placeholder="Email" required>
                            </div>
                            <div class="mb-3">
                                <input type="password" class="form-control" id="loginPassword" placeholder="Password" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Login</button>
                        </form>
                        <div id="loginResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Token Display -->
        <div class="card mb-4" id="tokenCard" style="display: none;">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Your JWT Token</h5>
            </div>
            <div class="card-body">
                <p>This token proves you are logged in. In the next chapter, we'll use it to access protected routes.</p>
                <div class="token-display" id="tokenDisplay"></div>
                <button class="btn btn-sm btn-outline-primary mt-2" onclick="copyToken()">Copy Token</button>
                <hr>
                <h6>Decoded Payload:</h6>
                <pre id="decodedPayload" class="bg-light p-2 rounded"></pre>
            </div>
        </div>

        <!-- localStorage Demo -->
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Key Concept: Token Storage</h5>
            </div>
            <div class="card-body">
                <p>After login, the token is stored in <code>localStorage</code>:</p>
                <pre class="bg-light p-2 rounded">localStorage.setItem('token', 'eyJ...');</pre>
                <p>We'll send this token with every request to protected routes (Chapter 4).</p>
            </div>
        </div>

        <div class="text-center mt-4">
            <a href="../../chapter-2/frontend/index.html" class="btn btn-outline-secondary me-2">← Chapter 2</a>
            <a href="../../chapter-4/frontend/index.html" class="btn btn-outline-primary">Chapter 4: Protected Routes →</a>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5003';

        // Register
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const resultDiv = document.getElementById('registerResult');

            try {
                const res = await fetch(`${API_URL}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                resultDiv.innerHTML = res.ok
                    ? `<div class="alert alert-success">${data.message}</div>`
                    : `<div class="alert alert-danger">${data.message}</div>`;
            } catch (err) {
                resultDiv.innerHTML = `<div class="alert alert-danger">Cannot connect to server</div>`;
            }
        });

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const resultDiv = document.getElementById('loginResult');

            try {
                const res = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();

                if (res.ok) {
                    resultDiv.innerHTML = `<div class="alert alert-success">${data.message}</div>`;

                    // Store token in localStorage
                    localStorage.setItem('token', data.token);

                    // Display token
                    document.getElementById('tokenCard').style.display = 'block';
                    document.getElementById('tokenDisplay').textContent = data.token;

                    // Decode and show payload (just the middle part)
                    const payload = JSON.parse(atob(data.token.split('.')[1]));
                    payload.exp_readable = new Date(payload.exp * 1000).toLocaleString();
                    document.getElementById('decodedPayload').textContent = JSON.stringify(payload, null, 2);
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="alert alert-danger">Cannot connect to server</div>`;
            }
        });

        function copyToken() {
            const token = document.getElementById('tokenDisplay').textContent;
            navigator.clipboard.writeText(token);
            alert('Token copied to clipboard!');
        }

        // Check if token exists in localStorage
        const savedToken = localStorage.getItem('token');
        if (savedToken) {
            document.getElementById('tokenCard').style.display = 'block';
            document.getElementById('tokenDisplay').textContent = savedToken;
            try {
                const payload = JSON.parse(atob(savedToken.split('.')[1]));
                payload.exp_readable = new Date(payload.exp * 1000).toLocaleString();
                document.getElementById('decodedPayload').textContent = JSON.stringify(payload, null, 2);
            } catch (e) {}
        }
    </script>
</body>
</html>
