<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Part 10: Refresh Token & Logout</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

    <div class="container py-5">
        <h1 class="text-center mb-4">Part 10: Refresh Token & Logout</h1>
        <p class="text-center text-muted mb-5">Access token + Refresh token pattern</p>

        <!-- ================================== -->
        <!-- Token Status -->
        <!-- ================================== -->
        <div class="row justify-content-center mb-4">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">Token Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Access Token:</h6>
                                <div id="accessTokenStatus" class="bg-light p-2 rounded small" style="word-break: break-all; max-height: 80px; overflow-y: auto;">
                                    None
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Refresh Token:</h6>
                                <div id="refreshTokenStatus" class="bg-light p-2 rounded small" style="word-break: break-all; max-height: 80px; overflow-y: auto;">
                                    None
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- ================================== -->
            <!-- Auth Section -->
            <!-- ================================== -->
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">1. Login</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="email" id="email" class="form-control" placeholder="Email">
                        </div>
                        <div class="mb-3">
                            <input type="password" id="password" class="form-control" placeholder="Password">
                        </div>
                        <button onclick="register()" class="btn btn-outline-primary w-100 mb-2">Register</button>
                        <button onclick="login()" class="btn btn-primary w-100">Login</button>
                        <div id="authResult" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- ================================== -->
            <!-- Token Operations -->
            <!-- ================================== -->
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">2. Token Operations</h5>
                    </div>
                    <div class="card-body">
                        <button onclick="refreshToken()" class="btn btn-success w-100 mb-2">
                            Refresh Access Token
                        </button>
                        <button onclick="logout()" class="btn btn-danger w-100 mb-2">
                            Logout (Revoke Refresh Token)
                        </button>
                        <button onclick="clearTokens()" class="btn btn-outline-secondary w-100">
                            Clear Local Tokens
                        </button>
                        <div id="tokenResult" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- ================================== -->
            <!-- API Test -->
            <!-- ================================== -->
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0">3. Test API</h5>
                    </div>
                    <div class="card-body">
                        <button onclick="getProfile()" class="btn btn-warning w-100 mb-2">
                            GET /profile
                        </button>
                        <button onclick="getProfileWithAutoRefresh()" class="btn btn-outline-warning w-100">
                            GET /profile (Auto Refresh)
                        </button>
                        <div id="apiResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================================== -->
        <!-- How It Works -->
        <!-- ================================== -->
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">How Refresh Tokens Work</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Token Lifetimes:</h6>
                                <ul>
                                    <li><strong>Access Token:</strong> 15 minutes</li>
                                    <li><strong>Refresh Token:</strong> 7 days</li>
                                </ul>
                                <h6>Flow:</h6>
                                <ol>
                                    <li>Login returns both tokens</li>
                                    <li>Use access token for API calls</li>
                                    <li>When access token expires, use refresh token</li>
                                    <li>Get new access token without re-login</li>
                                </ol>
                            </div>
                            <div class="col-md-6">
                                <h6>Auto-Refresh Pattern:</h6>
                                <pre class="bg-dark text-white p-2 rounded small">
async function apiCall(url) {
  let res = await fetch(url, {
    headers: { Authorization: 'Bearer ' + accessToken }
  });

  // If expired, refresh and retry
  if (res.status === 401) {
    await refreshToken();
    res = await fetch(url, {...});
  }

  return res;
}</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5010';

        // ===========================================
        // Token Management
        // ===========================================

        function getAccessToken() {
            return localStorage.getItem('accessToken');
        }

        function getRefreshToken() {
            return localStorage.getItem('refreshToken');
        }

        function saveTokens(accessToken, refreshToken) {
            localStorage.setItem('accessToken', accessToken);
            if (refreshToken) {
                localStorage.setItem('refreshToken', refreshToken);
            }
            updateTokenDisplay();
        }

        function clearTokens() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            updateTokenDisplay();
            showResult('tokenResult', 'Tokens cleared from browser', 'info');
        }

        function updateTokenDisplay() {
            const accessToken = getAccessToken();
            const refreshToken = getRefreshToken();

            document.getElementById('accessTokenStatus').innerHTML = accessToken
                ? `<span class="text-success">${accessToken.substring(0, 50)}...</span>`
                : '<span class="text-muted">None</span>';

            document.getElementById('refreshTokenStatus').innerHTML = refreshToken
                ? `<span class="text-success">${refreshToken.substring(0, 50)}...</span>`
                : '<span class="text-muted">None</span>';
        }

        // ===========================================
        // Auth Functions
        // ===========================================

        async function register() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showResult('authResult', 'Enter email and password', 'warning');
                return;
            }

            try {
                const response = await fetch(API_URL + '/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                showResult('authResult', data.message, response.ok ? 'success' : 'danger');
            } catch (error) {
                showResult('authResult', 'Network error', 'danger');
            }
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                showResult('authResult', 'Enter email and password', 'warning');
                return;
            }

            try {
                const response = await fetch(API_URL + '/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();

                if (response.ok) {
                    // Save BOTH tokens
                    saveTokens(data.access_token, data.refresh_token);
                    showResult('authResult',
                        `Login successful!<br><small>Access expires in ${data.expires_in}s</small>`,
                        'success'
                    );
                } else {
                    showResult('authResult', data.message, 'danger');
                }
            } catch (error) {
                showResult('authResult', 'Network error', 'danger');
            }
        }

        // ===========================================
        // Refresh Token
        // ===========================================

        async function refreshToken() {
            const refreshToken = getRefreshToken();

            if (!refreshToken) {
                showResult('tokenResult', 'No refresh token! Please login.', 'warning');
                return false;
            }

            try {
                const response = await fetch(API_URL + '/refresh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refresh_token: refreshToken })
                });
                const data = await response.json();

                if (response.ok) {
                    // Save new access token (keep refresh token)
                    saveTokens(data.access_token, null);
                    showResult('tokenResult',
                        `Token refreshed!<br><small>New access token expires in ${data.expires_in}s</small>`,
                        'success'
                    );
                    return true;
                } else {
                    showResult('tokenResult', data.message, 'danger');
                    // If refresh failed, clear tokens
                    if (response.status === 401) {
                        clearTokens();
                    }
                    return false;
                }
            } catch (error) {
                showResult('tokenResult', 'Network error', 'danger');
                return false;
            }
        }

        // ===========================================
        // Logout
        // ===========================================

        async function logout() {
            const refreshToken = getRefreshToken();

            if (!refreshToken) {
                showResult('tokenResult', 'No refresh token to revoke', 'info');
                clearTokens();
                return;
            }

            try {
                const response = await fetch(API_URL + '/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refresh_token: refreshToken })
                });
                const data = await response.json();

                showResult('tokenResult', data.message, 'success');
                clearTokens();
            } catch (error) {
                showResult('tokenResult', 'Network error', 'danger');
            }
        }

        // ===========================================
        // API Calls
        // ===========================================

        async function getProfile() {
            const accessToken = getAccessToken();

            if (!accessToken) {
                showResult('apiResult', 'No access token! Please login.', 'warning');
                return;
            }

            try {
                const response = await fetch(API_URL + '/profile', {
                    headers: { 'Authorization': 'Bearer ' + accessToken }
                });
                const data = await response.json();

                if (response.ok) {
                    showResult('apiResult',
                        `Profile: ${data.profile.email}`,
                        'success'
                    );
                } else {
                    showResult('apiResult',
                        `Error: ${data.message}<br><small>${data.error || ''}</small>`,
                        'danger'
                    );
                }
            } catch (error) {
                showResult('apiResult', 'Network error', 'danger');
            }
        }

        async function getProfileWithAutoRefresh() {
            /**
             * This demonstrates auto-refresh pattern:
             * 1. Try API call
             * 2. If 401 (token expired), refresh and retry
             */

            const accessToken = getAccessToken();

            if (!accessToken) {
                showResult('apiResult', 'No access token! Please login.', 'warning');
                return;
            }

            try {
                // First attempt
                let response = await fetch(API_URL + '/profile', {
                    headers: { 'Authorization': 'Bearer ' + accessToken }
                });

                // If token expired, try refresh
                if (response.status === 401) {
                    showResult('apiResult', 'Token expired, refreshing...', 'info');

                    const refreshed = await refreshToken();

                    if (refreshed) {
                        // Retry with new token
                        response = await fetch(API_URL + '/profile', {
                            headers: { 'Authorization': 'Bearer ' + getAccessToken() }
                        });
                    } else {
                        showResult('apiResult', 'Refresh failed. Please login again.', 'danger');
                        return;
                    }
                }

                const data = await response.json();

                if (response.ok) {
                    showResult('apiResult',
                        `Profile: ${data.profile.email}<br><small>(auto-refresh worked!)</small>`,
                        'success'
                    );
                } else {
                    showResult('apiResult', data.message, 'danger');
                }

            } catch (error) {
                showResult('apiResult', 'Network error', 'danger');
            }
        }

        // ===========================================
        // Helper
        // ===========================================

        function showResult(elementId, message, type) {
            document.getElementById(elementId).innerHTML = `
                <div class="alert alert-${type} py-2 mb-0 small">${message}</div>
            `;
        }

        // Initialize display
        updateTokenDisplay();
    </script>

</body>
</html>
