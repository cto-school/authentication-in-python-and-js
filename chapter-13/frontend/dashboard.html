<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Production Auth</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="dashboard-container">
        <header class="dashboard-header">
            <div class="user-info">
                <div class="user-avatar" id="avatar">?</div>
                <div>
                    <strong id="userName">Loading...</strong><br>
                    <small id="userEmail" style="color: #666;"></small>
                </div>
            </div>
            <div>
                <button class="btn btn-outline" onclick="logout()" style="width: auto; padding: 8px 20px;">Sign Out</button>
            </div>
        </header>

        <div class="card">
            <h2>Welcome to Your Dashboard</h2>
            <p>You are now logged in with a secure authentication system.</p>

            <div id="verificationStatus" style="margin-top: 15px;"></div>
        </div>

        <div class="card">
            <h2>Your Profile</h2>
            <div id="profileInfo">
                <table style="width: 100%; border-collapse: collapse;">
                    <tr><td style="padding: 10px 0; border-bottom: 1px solid #eee;"><strong>Email</strong></td><td id="profileEmail"></td></tr>
                    <tr><td style="padding: 10px 0; border-bottom: 1px solid #eee;"><strong>Name</strong></td><td id="profileName"></td></tr>
                    <tr><td style="padding: 10px 0; border-bottom: 1px solid #eee;"><strong>Auth Provider</strong></td><td id="profileProvider"></td></tr>
                    <tr><td style="padding: 10px 0; border-bottom: 1px solid #eee;"><strong>Email Verified</strong></td><td id="profileVerified"></td></tr>
                    <tr><td style="padding: 10px 0; border-bottom: 1px solid #eee;"><strong>Role</strong></td><td id="profileRole"></td></tr>
                    <tr><td style="padding: 10px 0;"><strong>Last Login</strong></td><td id="profileLastLogin"></td></tr>
                </table>
            </div>
        </div>

        <div class="card">
            <h2>Change Password</h2>
            <form id="changePasswordForm" onsubmit="changePassword(event)">
                <div class="form-group">
                    <label>Current Password</label>
                    <input type="password" id="currentPassword" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>New Password</label>
                    <input type="password" id="newPassword" class="form-control" required minlength="8">
                </div>
                <button type="submit" class="btn btn-primary" style="width: auto;">Change Password</button>
                <span id="passwordMsg" style="margin-left: 15px;"></span>
            </form>
        </div>

        <div class="card">
            <h2>Security</h2>
            <button class="btn btn-outline" onclick="logoutAll()" style="width: auto; background: #dc3545; color: white; border: none;">
                Log Out From All Devices
            </button>
            <p style="margin-top: 10px; color: #666; font-size: 14px;">
                This will revoke all your active sessions and require re-authentication on all devices.
            </p>
        </div>
    </div>

    <script>
        // ================================================================================
        // API CONFIGURATION
        // ================================================================================
        // Full URL required for cross-origin requests (CORS must be enabled on backend)
        // This allows the frontend to be served from any origin while calling our API
        // ================================================================================
        const API_URL = 'http://localhost:5013/api';

        // Check authentication
        function checkAuth() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/login.html';
                return false;
            }
            return true;
        }

        if (!checkAuth()) {
            // Stop execution if not authenticated
        }

        // Get auth headers
        function getHeaders() {
            return {
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                'Content-Type': 'application/json'
            };
        }

        // Load profile
        async function loadProfile() {
            try {
                const res = await fetch(`${API_URL}/profile`, { headers: getHeaders() });

                if (res.status === 401) {
                    // Try to refresh token
                    const refreshed = await refreshToken();
                    if (!refreshed) {
                        window.location.href = '/login.html';
                        return;
                    }
                    return loadProfile();
                }

                const data = await res.json();

                if (data.success && data.user) {
                    const user = data.user;
                    localStorage.setItem('user', JSON.stringify(user));

                    // Update header
                    document.getElementById('userName').textContent = user.name || 'User';
                    document.getElementById('userEmail').textContent = user.email;

                    // Avatar
                    if (user.profile_picture) {
                        document.getElementById('avatar').innerHTML = `<img src="${user.profile_picture}" style="width:100%;height:100%;border-radius:50%;">`;
                    } else {
                        document.getElementById('avatar').textContent = (user.name || user.email)[0].toUpperCase();
                    }

                    // Profile table
                    document.getElementById('profileEmail').textContent = user.email;
                    document.getElementById('profileName').textContent = user.name || '-';
                    document.getElementById('profileProvider').textContent = user.auth_provider.toUpperCase();
                    document.getElementById('profileVerified').innerHTML = user.is_verified
                        ? '<span style="color: green;">Yes</span>'
                        : '<span style="color: orange;">No</span>';
                    document.getElementById('profileRole').textContent = user.role.toUpperCase();
                    document.getElementById('profileLastLogin').textContent = user.last_login || 'First login';

                    // Verification status
                    if (!user.is_verified) {
                        document.getElementById('verificationStatus').innerHTML = `
                            <div class="message info">
                                Your email is not verified.
                                <a href="#" onclick="resendVerification()">Resend verification email</a>
                            </div>
                        `;
                    }
                }
            } catch (err) {
                console.error('Error loading profile:', err);
            }
        }

        // Refresh access token
        async function refreshToken() {
            const refreshToken = localStorage.getItem('refresh_token');
            if (!refreshToken) return false;

            try {
                const res = await fetch(`${API_URL}/refresh`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${refreshToken}` }
                });

                const data = await res.json();
                if (data.success && data.access_token) {
                    localStorage.setItem('access_token', data.access_token);
                    return true;
                }
            } catch (err) {
                console.error('Error refreshing token:', err);
            }
            return false;
        }

        // Change password
        async function changePassword(e) {
            e.preventDefault();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const msgEl = document.getElementById('passwordMsg');

            try {
                const res = await fetch(`${API_URL}/change-password`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({ current_password: currentPassword, new_password: newPassword })
                });

                const data = await res.json();
                msgEl.style.color = data.success ? 'green' : 'red';
                msgEl.textContent = data.message;

                if (data.success) {
                    document.getElementById('changePasswordForm').reset();
                }
            } catch (err) {
                msgEl.style.color = 'red';
                msgEl.textContent = 'Error changing password';
            }
        }

        // Resend verification
        async function resendVerification() {
            const user = JSON.parse(localStorage.getItem('user'));
            const res = await fetch(`${API_URL}/resend-verification`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: user.email })
            });
            const data = await res.json();
            alert(data.message);
        }

        // Logout
        async function logout() {
            const refreshToken = localStorage.getItem('refresh_token');
            if (refreshToken) {
                await fetch(`${API_URL}/logout`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${refreshToken}` }
                });
            }
            localStorage.clear();
            window.location.href = '/';
        }

        // Logout all devices
        async function logoutAll() {
            if (!confirm('This will log you out from all devices. Continue?')) return;

            await fetch(`${API_URL}/logout-all`, {
                method: 'POST',
                headers: getHeaders()
            });

            localStorage.clear();
            window.location.href = '/login.html';
        }

        // Load profile on page load
        loadProfile();
    </script>
</body>
</html>
