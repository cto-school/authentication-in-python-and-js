<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Part 5: Forgot Password</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

    <div class="container py-5">
        <h1 class="text-center mb-4">Part 5: Forgot Password (Local)</h1>
        <p class="text-center text-muted mb-5">Generate password reset link for local testing</p>

        <div class="row">
            <!-- ================================== -->
            <!-- Register (for testing) -->
            <!-- ================================== -->
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">1. Register First (Testing)</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="email" id="registerEmail" class="form-control" placeholder="Email">
                        </div>
                        <div class="mb-3">
                            <input type="password" id="registerPassword" class="form-control" placeholder="Password">
                        </div>
                        <button onclick="register()" class="btn btn-secondary w-100">
                            Register
                        </button>
                        <div id="registerResult" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- ================================== -->
            <!-- Forgot Password -->
            <!-- ================================== -->
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">2. Forgot Password</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small">Enter your email to get a reset link</p>

                        <div class="mb-3">
                            <label class="form-label">Email:</label>
                            <input type="email" id="forgotEmail" class="form-control" placeholder="Enter your email">
                        </div>

                        <button onclick="forgotPassword()" class="btn btn-primary w-100">
                            Get Reset Link
                        </button>

                        <div id="forgotResult" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- ================================== -->
            <!-- Verify Token -->
            <!-- ================================== -->
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">3. Verify Token</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small">Check if a token is valid</p>

                        <div class="mb-3">
                            <label class="form-label">Token:</label>
                            <input type="text" id="verifyToken" class="form-control" placeholder="Paste token here">
                        </div>

                        <button onclick="verifyToken()" class="btn btn-success w-100">
                            Verify Token
                        </button>

                        <div id="verifyResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================================== -->
        <!-- Reset Link Display -->
        <!-- ================================== -->
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0">Generated Reset Link</h5>
                    </div>
                    <div class="card-body">
                        <div id="resetLinkDisplay">
                            <p class="text-muted">Reset link will appear here after clicking "Get Reset Link"</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================================== -->
        <!-- How It Works -->
        <!-- ================================== -->
        <div class="row justify-content-center mt-4">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">How Forgot Password Works</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Local Testing (This Part):</h6>
                                <ol>
                                    <li>User enters email</li>
                                    <li>Backend generates reset token</li>
                                    <li>Backend returns reset link</li>
                                    <li>User copies link and opens it</li>
                                </ol>
                            </div>
                            <div class="col-md-6">
                                <h6>Production (Part 7 - Mailgun):</h6>
                                <ol>
                                    <li>User enters email</li>
                                    <li>Backend generates reset token</li>
                                    <li>Backend sends link via email</li>
                                    <li>User clicks link in email</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5005';

        // -----------------------------------------
        // Register (for testing)
        // -----------------------------------------
        async function register() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            if (!email || !password) {
                showResult('registerResult', 'Enter email and password', 'danger');
                return;
            }

            try {
                const response = await fetch(API_URL + '/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                showResult('registerResult', data.message, response.ok ? 'success' : 'danger');

                // Copy email to forgot password field
                if (response.ok) {
                    document.getElementById('forgotEmail').value = email;
                }
            } catch (error) {
                showResult('registerResult', 'Error: ' + error.message, 'danger');
            }
        }

        // -----------------------------------------
        // Forgot Password
        // -----------------------------------------
        async function forgotPassword() {
            const email = document.getElementById('forgotEmail').value;

            if (!email) {
                showResult('forgotResult', 'Please enter your email', 'danger');
                return;
            }

            try {
                // Call forgot-password API
                const response = await fetch(API_URL + '/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();

                if (response.ok) {
                    // Success - show the reset link
                    showResult('forgotResult', data.message, 'success');

                    // Display the reset link
                    document.getElementById('resetLinkDisplay').innerHTML = `
                        <div class="alert alert-success">
                            <strong>Reset Link Generated!</strong>
                            <hr>
                            <p><strong>Link:</strong></p>
                            <div class="bg-light p-2 rounded mb-3" style="word-break: break-all;">
                                <a href="${data.reset_link}" target="_blank">${data.reset_link}</a>
                            </div>
                            <p><strong>Token:</strong></p>
                            <div class="bg-light p-2 rounded mb-3" style="word-break: break-all;">
                                <code>${data.token}</code>
                            </div>
                            <p class="mb-0"><small class="text-muted">Expires in: ${data.expires_in}</small></p>
                        </div>
                    `;

                    // Copy token to verify field
                    document.getElementById('verifyToken').value = data.token;

                } else {
                    showResult('forgotResult', data.message, 'danger');
                }

            } catch (error) {
                showResult('forgotResult', 'Error: ' + error.message, 'danger');
            }
        }

        // -----------------------------------------
        // Verify Token
        // -----------------------------------------
        async function verifyToken() {
            const token = document.getElementById('verifyToken').value;

            if (!token) {
                showResult('verifyResult', 'Please enter a token', 'danger');
                return;
            }

            try {
                const response = await fetch(API_URL + '/verify-reset-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token })
                });

                const data = await response.json();

                if (data.valid) {
                    showResult('verifyResult',
                        `Token is VALID!<br><small>Email: ${data.email}</small>`,
                        'success'
                    );
                } else {
                    showResult('verifyResult', data.message, 'danger');
                }

            } catch (error) {
                showResult('verifyResult', 'Error: ' + error.message, 'danger');
            }
        }

        // -----------------------------------------
        // Helper Function
        // -----------------------------------------
        function showResult(elementId, message, type) {
            document.getElementById(elementId).innerHTML = `
                <div class="alert alert-${type} py-2 mb-0">
                    ${message}
                </div>
            `;
        }
    </script>

</body>
</html>
